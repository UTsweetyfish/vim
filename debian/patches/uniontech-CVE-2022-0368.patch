Index: vim/src/testdir/test_visual.vim
===================================================================
--- vim.orig/src/testdir/test_visual.vim
+++ vim/src/testdir/test_visual.vim
@@ -422,6 +422,21 @@ func Test_visual_ex_copy_line()
   bwipe!
 endfunc
 
+" This was leaving the end of the Visual area beyond the end of a line.
+" Set 'undolevels' to start a new undo block.
+func Test_visual_undo_deletes_last_line()
+  new
+  call setline(1, ["aaa", "ccc", "dyd"])
+  set undolevels=100
+  exe "normal obbbbbbbbbxbb\<Esc>"
+  set undolevels=100
+  /y
+  exe "normal ggvjfxO"
+  undo
+  normal gNU
+  bwipe!
+endfunc
+
 func Test_Visual_paragraph_textobject()
   new
   let lines =<< trim [END]
Index: vim/src/undo.c
===================================================================
--- vim.orig/src/undo.c
+++ vim/src/undo.c
@@ -3035,6 +3035,8 @@ u_undo_end(
     }
 #endif
 
+    if (VIsual_active)
+	check_pos(curbuf, &VIsual);
     smsg_attr_keep(0, _("%ld %s; %s #%ld  %s"),
 	    u_oldcount < 0 ? -u_oldcount : u_oldcount,
 	    _(msgstr),
