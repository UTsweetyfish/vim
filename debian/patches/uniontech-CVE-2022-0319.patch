Index: vim/src/testdir/test_visual.vim
===================================================================
--- vim.orig/src/testdir/test_visual.vim
+++ vim/src/testdir/test_visual.vim
@@ -463,6 +463,16 @@ func Test_Visual_paragraph_textobject()
   bwipe!
 endfunc
 
+" this was causing an ml_get error
+func Test_visual_exchange_windows()
+  enew!
+  new
+  call setline(1, ['foo', 'bar'])
+  exe "normal G\<C-V>gg\<C-W>\<C-X>OO\<Esc>"
+  bwipe!
+  bwipe!
+endfunc
+
 func Test_curswant_not_changed()
   new
   call setline(1, ['one', 'two'])
Index: vim/src/window.c
===================================================================
--- vim.orig/src/window.c
+++ vim/src/window.c
@@ -1691,6 +1691,11 @@ win_exchange(long Prenum)
 
     (void)win_comp_pos();		// recompute window positions
 
+    if (wp->w_buffer != curbuf)
+	reset_VIsual_and_resel();
+    else if (VIsual_active)
+	wp->w_cursor = curwin->w_cursor;
+
     win_enter(wp, TRUE);
     redraw_all_later(NOT_VALID);
 }
